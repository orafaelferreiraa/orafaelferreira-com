name: deploy-app

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'package-lock.json'
      - 'bun.lockb'
      - 'tsconfig*.json'
      - 'vite.config.ts'
      - 'tailwind.config.ts'
      - 'postcss.config.js'
      - 'eslint.config.js'
      - 'tsconfig.node.json'
      - '.github/workflows/deploy-app.yml'  
  # Não roda em PRs; somente push e workflow_run após apply

  workflow_run:
    workflows: ["infra-apply"]
    types:
      - completed
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: deploy-app-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build_and_deploy:
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm install

      # Stage 1: fast unit tests (test pyramid base)
      - name: Unit tests
        run: npm run test:ci

      # Stage 2: component tests (React Testing Library)
      - name: Component tests
        run: npm run test:components:ci

      - name: Type check
        run: npm run typecheck

      - name: Build app
        run: npm run build


      - name: Detect infra changes
        if: github.event_name == 'push'
        id: infra
        uses: tj-actions/changed-files@v45
        with:
          files: |
            infra/**
            .github/workflows/infra.yml
            .github/workflows/infra-plan.yml

      # Stage 3: end-to-end smoke (Playwright)
      # - name: Install Playwright browsers
      #   run: npx playwright install --with-deps

      # - name: E2E smoke tests
      #   run: npm run test:e2e:ci

      - name: Deploy to Azure Static Web Apps
        if: |
          (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
          (github.event_name == 'push' && steps.infra.outputs.any_changed != 'true')
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true

      - name: Skip reason (deploy suprimido por mudanças em infra)
        if: github.event_name == 'push' && steps.infra.outputs.any_changed == 'true'
        run: |
          echo "Alterações em 'infra/**' detectadas neste commit/PR."
          echo "O deploy do app será executado após a conclusão bem-sucedida do workflow 'infra-apply' (via workflow_run)."

      - name: Job summary
        if: always()
        run: |
          {
            echo "## App Deploy Summary";
            echo "";
            echo "- Event: ${{ github.event_name }}";
            echo "- Ref: ${{ github.ref }}";
            echo "- Actor: ${{ github.actor }}";
            echo "";
            echo "### Build";
            echo "- Output dir: \`dist/\`";
            echo "- Files: $(find dist -type f | wc -l 2>/dev/null || echo 'n/a')";
            echo "- Size: $(du -sh dist 2>/dev/null | cut -f1 || echo 'n/a')";
            echo "";
            echo "### Deploy";
            echo "Aplicação enviada para o Azure Static Web Apps (upload de \`dist/\`).";
          } >> "$GITHUB_STEP_SUMMARY"