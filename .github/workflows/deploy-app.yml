name: deploy-app

on:
  # Dispara em pushes no main quando arquivos do app mudarem
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'package-lock.json'
      - 'bun.lockb'
      - 'tsconfig*.json'
      - 'vite.config.ts'
      - 'tailwind.config.ts'
      - 'postcss.config.js'
      - 'eslint.config.js'
      - 'tsconfig.node.json'
      - '.github/workflows/deploy-app.yml'
  
  # Dispara em PRs
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'infra/**'
      - '.github/workflows/infra.yml'
  
  # Dispara automaticamente quando o workflow 'infra' completa com sucesso
  workflow_run:
    workflows: ["infra"]
    types:
      - completed
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: deploy-app-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build_and_deploy:
    # Só roda se:
    # - for push/PR normal do app OU
    # - workflow_run do infra completou com sucesso
    if: |
      (github.event_name == 'push' || github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm install

      # Stage 1: fast unit tests (test pyramid base)
      - name: Unit tests
        run: npm run test:ci

      # Stage 2: component tests (React Testing Library)
      - name: Component tests
        run: npm run test:components:ci

      - name: Type check
        run: npm run typecheck

      - name: Build app
        run: npm run build

      # Stage 3: end-to-end smoke (Playwright)
      - name: Install Playwright browsers
        uses: microsoft/playwright-github-action@v1

      - name: E2E smoke tests
        run: npm run test:e2e:ci

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: 'upload'
          app_location: 'dist'
          skip_app_build: true

      - name: Job summary
        if: always()
        run: |
          {
            echo "## App Deploy Summary";
            echo "";
            echo "- Event: ${{ github.event_name }}";
            echo "- Ref: ${{ github.ref }}";
            echo "- Actor: ${{ github.actor }}";
            echo "";
            echo "### Build";
            echo "- Output dir: \`dist/\`";
            echo "- Files: $(find dist -type f | wc -l 2>/dev/null || echo 'n/a')";
            echo "- Size: $(du -sh dist 2>/dev/null | cut -f1 || echo 'n/a')";
            echo "";
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "### Preview";
              echo "Este workflow cria/atualiza um Preview Environment no Azure Static Web Apps para este PR.";
            else
              echo "### Deploy";
              echo "Aplicação enviada para o Azure Static Web Apps (upload de \`dist/\`).";
            fi;
          } >> "$GITHUB_STEP_SUMMARY"